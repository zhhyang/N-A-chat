angular.module("NAChat",["ngRoute","angularMoment"]).run(["$window","$rootScope","$location","server",function(o,e,t,n){o.moment.locale("zh-cn"),n.validate().then(function(){"/login"===t.path()&&t.path("/rooms")},function(){t.path("/login")}),e.me=n.getUser(),e.logout=function(){n.logout().then(function(){t.path("/login")})}}]),angular.module("NAChat").config(function(o,e){o.when("/rooms",{templateUrl:"/pages/rooms.html",controller:"RoomsCtrl"}).when("/rooms/:_roomId",{templateUrl:"/pages/room.html",controller:"RoomCtrl"}).when("/login",{templateUrl:"/pages/login.html",controller:"LoginCtrl"}).otherwise({redirectTo:"/login"})}),angular.module("NAChat").controller("LoginCtrl",["$scope","$location","server",function(o,e,t){o.login=function(){t.login(o.email).then(function(){e.path("/rooms")},function(){e.path("/login")})}}]),angular.module("NAChat").controller("MessageCreatorCtrl",["$scope","$routeParams","server",function(o,e,t){o.newMessage="",o.createMessage=function(){""!=o.newMessage&&(t.createMessage({message:o.newMessage,creator:o.me,_roomId:e._roomId}),o.newMessage="")}}]),angular.module("NAChat").controller("RoomCtrl",["$scope","$routeParams","socket","server",function(o,e,t,n){o.room=n.getRoom(e._roomId),n.joinRoom({user:o.me,room:{_id:e._roomId}}),o.$on("$routeChangeStart",function(){n.leaveRoom({user:o.me,_roomId:e._roomId})})}]),angular.module("NAChat").controller("RoomsCtrl",["$scope","$location","socket","server",function(o,e,t,n){var r=n.getAllRooms();o.searchRoom=function(){o.searchKey?o.filteredRooms=o.rooms.filter(function(e){return e.name.indexOf(o.searchKey)>-1}):o.filteredRooms=o.rooms},o.createRoom=function(){n.createRoom({name:o.searchKey})},o.filteredRooms=o.rooms=r,o.enterRoom=function(o){e.path("/rooms/"+o._id)},o.$watchCollection("rooms",function(){o.searchRoom()})}]),angular.module("NAChat").directive("autoScrollToBottom",function(){return{link:function(o,e,t){o.$watch(function(){return e.children().length},function(){e[0].scrollTop=e[0].scrollHeight-e[0].clientHeight})}}}),angular.module("NAChat").directive("ctrlEnterBreakLine",function(){return function(o,e,t){var n=!1;e.bind("keydown",function(r){17===r.which&&(n=!0,setTimeout(function(){n=!1},1e3)),13===r.which&&(n?e.val(e.val()+"\n"):(o.$apply(function(){o.$eval(t.ctrlEnterBreakLine)}),r.preventDefault()))})}}),angular.module("NAChat").factory("server",["$cacheFactory","$q","$http","socket",function(o,e,t,n){var r=window.cache=o("nachat");return n.on("nachat",function(o){switch(o.action){case"roomData":o._roomId?angular.extend(r.get(o._roomId),o.data):o.data.forEach(function(o){r.get("rooms").push(o)});break;case"leaveRoom":var e=o.data,t=e.user._id,n=e.user._roomId;r.get(n).users=r.get(n).users.filter(function(o){return o._id!=t}),r.get("rooms")&&r.get("rooms").forEach(function(o){o._id===n&&(o.users=o.users.filter(function(o){return o._id!==t}))});break;case"roomAdded":r.get("rooms").push(o.data);break;case"joinRoom":var a=o.data,t=a.user._id,n=a.room._id;r.get(n)||r.get("rooms").forEach(function(o){o._id===n&&r.put(n,o)}),r.get(n).users.push(a.user);break;case"messageAdded":var c=o.data;r.get(c._roomId).messages.push(c)}}),n.on("err",function(o){console.log(o)}),{validate:function(){var o=e.defer();return t({url:"/api/validate",method:"GET"}).success(function(e){angular.extend(this.getUser(),e),o.resolve()}.bind(this)).error(function(e){o.reject()}),o.promise},getUser:function(){return r.get("user")||r.put("user",{}),r.get("user")},login:function(o){var n=e.defer();return t({url:"/api/login",method:"POST",data:{email:o}}).success(function(o){angular.extend(r.get("user"),o),n.resolve()}).error(function(){n.reject()}),n.promise},logout:function(){var o=e.defer();return t({url:"/api/logout",method:"GET"}).success(function(){var e=r.get("user");for(key in e)e.hasOwnProperty(key)&&delete e[key];o.resolve()}),o.promise},getAllRooms:function(){return r.get("rooms")||(r.put("rooms",[]),n.emit("nachat",{action:"getAllRooms"})),r.get("rooms")},getRoom:function(o){return r.get(o)||(r.put(o,{users:[],messages:[]}),n.emit("nachat",{action:"getAllRooms",data:{_roomId:o}})),r.get(o)},createRoom:function(o){n.emit("nachat",{action:"createRoom",data:o})},joinRoom:function(o){n.emit("nachat",{action:"joinRoom",data:o})},leaveRoom:function(o){n.emit("nachat",{action:"leaveRoom",data:o})},createRoom:function(o){n.emit("nachat",{action:"createRoom",data:o})},createMessage:function(o){n.emit("nachat",{action:"createMessage",data:o})}}}]),angular.module("NAChat").factory("socket",function(o){var e=io();return{on:function(t,n){e.on(t,function(){var t=arguments;o.$apply(function(){n.apply(e,t)})})},emit:function(t,n,r){e.emit(t,n,function(){var t=arguments;o.$apply(function(){r&&r.apply(e,t)})})}}});